MML for NASequencer Syntax
==========================
Version 0.5.0 Draft, 2016

MMLについて
-----------
Music Macro Language (MML) は、コンピュータ・ミュージックの黎明期にテキスト記述による音楽演奏のために作られた言語です。
歴史的な経緯のためか様々な実装があり、標準仕様が存在しません。
NASequencerでは、日本でよく使われているFlash用ライブラリの[FlMML](https://flmml.codeplex.com)の記法をベースにしています。
ですが、MIDIに特化させているため、音源モジュール関連の互換性はありません。
また、MIDIに関連する記法として[mml2mid](http://hpc.jp/~mml2mid/mml2mid.txt)の仕様を一部取り入れています。
その他、NASequencer独自の記法を追加しています。


基本的な構造
------------
### ファイルフォーマット
- 読み込み可能な拡張子は`.mml`です
- 演奏データはプレーンテキストで記述します
- 大文字小文字は区別されません
- 文字列やコメントを除いて、ASCIIコードで記述します
- 文字コードはASCIIとUTF-8のみサポートします

### トラック区切り
セミコロン(;)はトラックの区切りとして作用し、トラックを切り替えます。
トラックを切り替えると音符入力の開始地点となる現在位置がゼロに戻ります。

#### トラックとチャネル
MIDIのチャネルとトラックは連動していません。
チャネルを切り替える場合は[@ch](#@ch)コマンドで切り替えます。

#### トラックとチャネルの例
```
cccc;
eeee;

@CH2
cdef;
```

上記の結果は以下の様になります。

```
            | 1
==============================
Ch1 |060:C3 | .
    |059:B  | .
    |058:A# | .
    |057:A  | .
    |056:G# | .
    |055:G  | .
    |054:F# | .
    |053:F  | .
    |052:E  | x---x---x---x---
    |051:D# | .
    |050:D  | .
    |049:C# | .
    |048:C2 | x---x---x---x---
------------------------------
Ch2 |060:C3 | .
    |059:B  | .
    |058:A# | .
    |057:A  | .
    |056:G# | .
    |055:G  | .
    |054:F# | .
    |053:F  | .           x---
    |052:E  | .       x---
    |051:D# | .
    |050:D  | .   x---
    |049:C# | .
    |048:C2 | x---
```

チャネルの初期値は1です。

### コメント
`//`から改行まではコメントとして処理されます。
複数行のコメントは`/*`から `*/` までがコメントとして処理されます。

### 文字列
`' '` もしくは `" "` で囲まれた部分は文字列として処理されます。

```
'これは 文字列です'
"これも 文字列です"
```

文字列は[\#title](##title) や [\#copyright](##copyright) 文で使用します。

### マクロ
マクロにより、事前に定義された内容と置き換えができます。
マクロの定義は`$定義名 = 置き換える内容;`で定義します。
`$定義名` とすることでマクロの展開が行われます。
セミコロンの前には改行を入れることが出来るので、複数行のマクロ定義も可能です。
```
$MACRO = abcd;

$MACRO // これは abcd に展開される
```

#### 引数付きマクロ
引数付きマクロは`$定義名{引数1, 引数2} = 置き換える内容;`で定義します。
置き換える内容に`%引数名` とすることで、マクロ呼び出し時の引数を展開できます。

```
$m{vol, note} = @V%vol %note;

$m{100, CDE} // これは @V100 CDE と展開される
```

_[FlMML マクロ機能詳細](https://flmml.codeplex.com/wikipage?title=Reference&referringTitle=Documentation#fl_macro)より_

※ マクロ機能はFlMMLの仕様に準じます

### インクルード
インクルードにより、他のファイルの定義などを読み込むことが出来ます。

```
#include 'drums.mml'
```

インクルードされるファイルは[インクルードサーチパス](TODO)で指定されたディレクトリ配下に配置して下さい。

他のファイルに、リズムトラックのマクロを定義したりして使用出来ます。


リファレンス
-----------
### 音符
#### 音階
音階の入力は 音名(CDEFGAB) + 臨時記号(+/#/-)で行います。
臨時記号は省略できます。
臨時記号はダブルシャープ(##/++)、ダブルフラット(--)の指定も可能です。

```
C    // C
C+   // C#
C++  // C## (Dと同じ)
C#   // C#
C##  // C## (Dと同じ)
D-   // D♭
D--  // D♭♭ (Cと同じ)
```

#### 音長
音階の後ろに数字をつけると音長を指定できます。
数字はN分音符を意味します。
```
C4 // 4分音符のド
```
付点をつけると付点N分音符になります。
```
C4. // 付点4分音符のド
```
複付点音符は2つまで可能です。
```
C4.. // 4分音符の7/4の長さ
```
%を使うと分解能の単位で絶対値入力が出来ます。
```
C%480 // 分解能480の場合、4分音符の長さ
```

音長を省略した場合、[デフォルト音長](#デフォルト音長)の長さが適用されます。

### 休符
Rで休符を入力できます。
休符の後ろには音符同様に音長を指定できます。
```
R4 // 4分休符
```

音長を省略した場合、[デフォルト音長](#デフォルト音長)の長さが適用されます。

### オクターブ
#### オクターブ指定
音符入力時のオクターブを指定します。
-2 ~ +8の範囲で指定できます。
デフォルトは+2です。

```
@o4  // オクターブ4
```

#### オクターブシフト
##### <
オクターブを相対的に1だけ上げます。

##### >
オクターブを相対的に1だけ下げます。

[#octave reverse](##octave reverse)により反転できます。

### #timebase
4分音符の分解能を指定します。
デフォルトは480です。
一つの演奏データにつき、１回だけ指定できます。
SMFファイルに出力した際、ヘッダチャンクの時間単位の値になります。
```
#timebase 960
```

### ノートシフト
#### 絶対ノートシフト
音符入力時の音階を半音単位で上下させます。
```
NS2  // 1音上げ
C    // Dの音になる
NS-2 // 1音下げ
C    // A#の音になる
```

#### 相対ノートシフト
音符入力時の音階を半音単位で上下させます。
絶対ノートシフトとの違いは直前のノートシフトの値から相対的に上下することです。
```
@NS2  // 1音上げ
C     // Dの音になる
@NS-2 // 1音上げから1音下げ
C     // Cの音に戻る
```

### デフォルト音長
音符入力時の音長指定を省略した場合の音長を指定できます。
指定できる範囲は1~384です。
デフォルトは4です。
384より大きい数字や、384分音符の整数倍の音長にならない数字を指定した場合、NASequencerではエラーにします。
指定可能な値は以下になります。
```
L384 L192 L128 L96 L64 L48 L32 L24 L16 L12 L8 L6 L4 L3 L2 L1
```

### ゲートタイム
#### ゲートタイムの割合指定
ゲートタイムの割合を指定します。
範囲は0～16です。
入力された音符のゲートタイムが<割合>/16になります。
デフォルトは15です。

```
Q14
C4 // ゲートタイムは4分音符の14/16の長さになる
```

#### ゲートタイムのマイナス割合の指定
ゲートタイムの割合指定で指定されたゲートタイムから全音符の<マイナス割合>/192の長さを引きます。

```
Q16
@Q 2
C4 // ゲートタイムは4分音符の190/192の長さになる
```

### ベロシティ
#### ベロシティの大まかな指定
ベロシティの大まかな指定をします。
範囲は0～15です。
ベロシティの値を(指定値× 8 + 7)で設定します。

```
V10  // @V87と同じ
```

#### ベロシティの細かい指定
ベロシティの細かい指定をします。
範囲は0～127です。
デフォルトは100です。

```
@V120  // ベロシティ 120
```

#### ベロシティシフト
##### (
ベロシティを相対的に1段階上げます。

##### )
オクターブを相対的に1段階下げます。

直前に使ったベロシティコマンドが`V`か`@V`かによって変化量が変わります。
数字を添えた場合、数字の数分、段階を上げ下げします。

```
V10
(2  // 2段階(8x2=16)上げる 
@V100
)5  // 5段階(1x5=5)下げる 
```

[#velocity reverse](##velocity reverse)により反転できます。

### 連符
`{}`で囲まれた音符は連符として作用します。
`{}`の後ろには音長を指定できます。
音長を省略した場合は[デフォルト音長](#デフォルト音長)で指定した長さになります。
一つ一つの連符の長さはトータルの長さが音長で指定された長さになるように均等に配分されます。

```
{CDE}4    // 3連符の例
          // この場合、L12 CDE と同じ
{CDEFGA}4 // 6連符の例
          // この場合、L24 CDEFGA と同じ
```

### 和音
`[]`で囲まれた音符は和音として作用します。

```
L4
[CEG] // Cコードで4分音符の長さになる
```

Rコマンドによって、和音の発音タイミングをずらすことが出来ます。

```
L8 [C4.RERG]D. C2
```

上記の結果は以下の様になります。

```
            | 1               2
===============================
Ch1 |060:C3 | .               .
    |059:B  | .               .
    |058:A# | .               .
    |057:A  | .               .
    |056:G# | .               .
    |055:G  | .   x-          .
    |054:F# | .               .
    |053:F  | .               .
    |052:E  | . x-            .
    |051:D# | .               .
    |050:D  | .     x--       .
    |049:C# | .               .
    |048:C2 | x-----   x-------
```

_[FlMML 発音数関連 和音記法より](https://flmml.codeplex.com/wikipage?title=Reference&referringTitle=Documentation#fl_poly)より_

### タイ
& 記号で直前の音符と同じ音程の音符をつなぐとタイとして作用します。
```
C4 & C8 // この場合、付点4分音符と同じ長さになります
```

和音についてもタイでつなぐことが出来ます。

```
L4
[CEG] & [CEG] // Cコードで2分音符分の長さになる
```

タイでつながれる音符が異なる音階の場合は何も行いません。
※ スラーはサポートしません

### リピート
繰り返しの指定を行います。
繰り返しの指定は`/:<繰り返し回数> ... / ... :/`の構文で行います。
<繰り返し回数>を省略した場合、繰り返し回数は2になります。
最終ループのとき、`/`があればループを抜けます。
`/`は省略可能です。

```
/:3 cde / fg :/  // これは cde fg cde fg cde と同じになる
```

### #title
演奏データのタイトルを設定します。
一つの演奏データにつき、１回だけ指定できます。
SMFファイルに出力した際、第一トラックにシーケンス名(FF 03h)として出力されます。

```
#title 'Syntax Reference'
```

### #copyright
演奏データの著作件情報を設定します。
一つの演奏データにつき、１回だけ指定できます。
SMFファイルに出力した際、第一トラックに著作権表示(FF 02h)として出力されます。
```
#copyright 'Copyright (c) 2016, Noriyoshi Abe. All Rights Reserved.'
```

### #marker
マーカーを挿入します。
プレイヤーのリピート状態が[リピートマーカー](TODO)になっている場合、リピート再生のセクション区切りとして作用します。
SMFファイルに出力した際、第一トラックにマーカーイベント(FF 06h)として出力されます。

```
#marker 'Intro'
```

### #velocity reverse
相対ベロシティ変更記号の機能を反転します。

```
#velocity reverse
```

デフォルトは以下になります。

|機能|記号|
|---|---|
|ベロシティアップ| `(` |
|ベロシティダウン| `)` |


### #octave reverse
相対オクターブ変更記号の機能を反転します。

```
#octave reverse
```

デフォルトは以下になります。

|機能|記号|
|---|---|
|オクターブアップ| `<` |
|オクターブダウン| `>` |

### t
Beat per Minutes(1分間の４分音符の数)の単位でテンポを指定します。
デフォルトは120.0です。
小数点第2位まで指定できます。
演奏データの途中から変更可能です。
SMFファイルに出力した際、第一トラックにテンポチェンジイベント(FF 51h 03h)として出力されます。

```
t 128.99
```

### @ch
チャネルを切り替えます。
使用可能なチャネルは1~16です。

```
@ch10
```

### @sy
チャネルのサウンドフォントを切り替えます。
予め指定するサウンドフォントが読み込まれている必要があります。

```
@sy 'SGM-V2.01'
```

### @bs
チャネルの音色変更で使用します。
MIDIメッセージのバンクセレクトに相当します。

```
@bs 128 // Bank No=128 (MSB=1, LSB=0)
```

SMFファイルに出力した際、

- コントロールチェンジ:バンクセレクトMSB(Bn 00h)
- コントロールチェンジ:バンクセレクトLSB(Bn 20h)

として出力されます。

[@pc](#@pc)も参照して下さい。

### @pc
チャネルの音色変更で使用します。
MIDIメッセージのプログラムチェンジに相当します。

```
@bs 128 // Bank No=128   一般的なGeneral MIDI対応シンセサイザーでのパーカッションバンク
@pc 0   // Program No=0  Standard Drums
```

SMFファイルに出力した際、プログラムチェンジ(Cn) として出力されます。

※ 音色が切り替わるのは@pcコマンドが再生された時になる事に注意して下さい

### @vl
チャネルのボリュームを指定します。
指定可能な値は0~127です。
デフォルトは100です。
SMFファイルに出力した際、コントロールチェンジ(Bn 07h) チャネルボリューム として出力されます。

```
@vl100
```

### @cs
チャネルのコーラスエフェクトのかかり具合を変更します。
指定可能な値は0~127です。
デフォルトは0です。

SMFファイルに出力した際、コントロールチェンジ(Bn 5Dh) エフェクト3デプス（コーラスセンドレベル）として出力されます。

```
@cs100
```

### @rv
チャネルのリバーブエフェクトのかかり具合を変更します。
指定可能な値は0~127です。
デフォルトは0です。
SMFファイルに出力した際、コントロールチェンジ(Bn 5Bh) エフェクト1デプス（リバーブセンドレベル）として出力されます。

```
@rv100
```

### @x
チャネルのエクスプレッションを指定します。
指定可能な値は0~127です。
デフォルトは127です。
SMFファイルに出力した際、コントロールチェンジ(Bn 0Bh) エクスプレッション として出力されます。

```
@x100
```

### @p
チャネルのパン(左右の定位)を指定します。
指定可能な値は0 ~ 127です。
0に近づくほど左に振れ、127に近づくほど右に振れます。
デフォルトは64(中央)です。

```
@p30
```

SMFファイルに出力した際、コントロールチェンジ(Bn 0Ah) パンとして出力されます。

### @d
シンセサイザのピッチをセント単位で調整します。
指定可能な値は上下2オクターブ(-2400 ~ +2400)です。
[ノートシフト](#ノートシフト)が音階を変更するのに対し、@dコマンドでは音階は変えずにシンセサイザのピッチを変更します。

```
@d-50
```

SMFファイルに出力した際、

- コントロールチェンジ:RPN（MSB）(Bn 65h 0) チャネル・ファイン・チューン
- コントロールチェンジ:RPN（LSB）(Bn 64h 1) チャネル・ファイン・チューン
- コントロールチェンジ:データエントリー(MSB) (Bn 06h)
- コントロールチェンジ:データエントリー(LSB) (Bn 26h)
- コントロールチェンジ:RPN（MSB）(Bn 65h 0) チャネル・コース・チューン
- コントロールチェンジ:RPN（LSB）(Bn 64h 2) チャネル・コース・チューン
- コントロールチェンジ:データエントリー(MSB) (Bn 06h) 
- コントロールチェンジ:RPN（MSB）(Bn 65h 7Fh) RPNヌル
- コントロールチェンジ:RPN（LSB）(Bn 64h 7Fh) RPNヌル

として出力されます。
